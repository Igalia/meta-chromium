From 3bc35be791436f0e259b250c3dc043205b54a213 Mon Sep 17 00:00:00 2001
From: Jose Dapena Paz <jdapena@igalia.com>
Date: Thu, 15 Feb 2024 11:17:09 +0000
Subject: GCC: fix template specialization in non-namespace scope in
 url_loader_factory_builder.h
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

GCC does not allow template specializations out in any non-namespace
scope.

Bug: 819294
Change-Id: Ia5e6e61801dfcd0c6b5269204fcd513d5064ffc3
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/5259257
Commit-Queue: Jos√© Dapena Paz <jdapena@igalia.com>
Reviewed-by: Kenichi Ishibashi <bashi@chromium.org>
Cr-Commit-Position: refs/heads/main@{#1260975}
---
 .../public/cpp/url_loader_factory_builder.cc  | 14 ++++++++
 .../public/cpp/url_loader_factory_builder.h   | 32 ++++++++-----------
 2 files changed, 28 insertions(+), 18 deletions(-)

diff --git a/services/network/public/cpp/url_loader_factory_builder.cc b/services/network/public/cpp/url_loader_factory_builder.cc
index 26e81de43a5e5..78d7b4e3593b4 100644
--- a/services/network/public/cpp/url_loader_factory_builder.cc
+++ b/services/network/public/cpp/url_loader_factory_builder.cc
@@ -77,4 +77,18 @@ void URLLoaderFactoryBuilder::ConnectTerminal(
                                            std::move(factory_param));
 }
 
+template <>
+scoped_refptr<SharedURLLoaderFactory> URLLoaderFactoryBuilder::WrapAs(
+    mojo::PendingRemote<mojom::URLLoaderFactory> in) {
+  return base::MakeRefCounted<WrapperSharedURLLoaderFactory>(std::move(in));
+}
+
+template <>
+mojo::PendingRemote<mojom::URLLoaderFactory> URLLoaderFactoryBuilder::WrapAs(
+    scoped_refptr<SharedURLLoaderFactory> in) {
+  mojo::PendingRemote<mojom::URLLoaderFactory> remote;
+  in->Clone(remote.InitWithNewPipeAndPassReceiver());
+  return remote;
+}
+
 }  // namespace network
diff --git a/services/network/public/cpp/url_loader_factory_builder.h b/services/network/public/cpp/url_loader_factory_builder.h
index 08aa10e2f03d4..85ba8d7fae96a 100644
--- a/services/network/public/cpp/url_loader_factory_builder.h
+++ b/services/network/public/cpp/url_loader_factory_builder.h
@@ -120,24 +120,6 @@ class COMPONENT_EXPORT(NETWORK_CPP) URLLoaderFactoryBuilder final {
     return std::move(in);
   }
 
-  // `PendingRemote` -> `SharedURLLoaderFactory`:
-  // Wraps by `WrapperSharedURLLoaderFactory`.
-  template <>
-  scoped_refptr<SharedURLLoaderFactory> WrapAs(
-      mojo::PendingRemote<mojom::URLLoaderFactory> in) {
-    return base::MakeRefCounted<WrapperSharedURLLoaderFactory>(std::move(in));
-  }
-
-  // `SharedURLLoaderFactory` -> `PendingRemote`:
-  // Creates a new pipe and cloning.
-  template <>
-  mojo::PendingRemote<mojom::URLLoaderFactory> WrapAs(
-      scoped_refptr<SharedURLLoaderFactory> in) {
-    mojo::PendingRemote<mojom::URLLoaderFactory> remote;
-    in->Clone(remote.InitWithNewPipeAndPassReceiver());
-    return remote;
-  }
-
   template <typename OutType>
   static OutType WrapAs(mojom::NetworkContext* context,
                         mojom::URLLoaderFactoryParamsPtr factory_param) {
@@ -172,6 +154,20 @@ class COMPONENT_EXPORT(NETWORK_CPP) URLLoaderFactoryBuilder final {
   mojo::PendingReceiver<mojom::URLLoaderFactory> tail_;
 };
 
+// `PendingRemote` -> `SharedURLLoaderFactory`:
+// Wraps by `WrapperSharedURLLoaderFactory`.
+template <>
+COMPONENT_EXPORT(NETWORK_CPP)
+scoped_refptr<SharedURLLoaderFactory> URLLoaderFactoryBuilder::WrapAs(
+    mojo::PendingRemote<mojom::URLLoaderFactory> in);
+
+// `SharedURLLoaderFactory` -> `PendingRemote`:
+// Creates a new pipe and cloning.
+template <>
+COMPONENT_EXPORT(NETWORK_CPP)
+mojo::PendingRemote<mojom::URLLoaderFactory> URLLoaderFactoryBuilder::WrapAs(
+    scoped_refptr<SharedURLLoaderFactory> in);
+
 }  // namespace network
 
 #endif  // SERVICES_NETWORK_PUBLIC_CPP_URL_LOADER_FACTORY_BUILDER_H_
-- 
2.40.1

