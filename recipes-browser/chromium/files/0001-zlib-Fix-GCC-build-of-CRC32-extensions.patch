From cdf142aad5b43835fb9947293ec3bcbe886fef18 Mon Sep 17 00:00:00 2001
From: Jose Dapena Paz <jdapena@igalia.com>
Date: Tue, 27 Sep 2022 10:22:17 +0000
Subject: [zlib] Fix GCC build of CRC32 extensions
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Recent changes to include support for PMULL require arm_neon.h
header. This was added for Clang, but not for GCC.

Also, we need to add AES instruction set to the module level
statement.

Bug: 819294
Change-Id: I442d5a3d3e33aa78f08f9ee1d5a4035f16b25b46
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/3917532
Commit-Queue: Jos√© Dapena Paz <jdapena@igalia.com>
Reviewed-by: Adenilson Cavalcanti <cavalcantii@chromium.org>
Cr-Commit-Position: refs/heads/main@{#1051716}
---
 third_party/zlib/BUILD.gn     | 2 +-
 third_party/zlib/crc32_simd.c | 1 +
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/third_party/zlib/BUILD.gn b/third_party/zlib/BUILD.gn
index ee7483e9ef6a4..66e37a9dcf270 100644
--- a/third_party/zlib/BUILD.gn
+++ b/third_party/zlib/BUILD.gn
@@ -144,7 +144,7 @@ if (use_arm_neon_optimizations) {
       if (!is_win && !is_clang) {
         assert(!use_thin_lto,
                "ThinLTO fails mixing different module-level targets")
-        cflags_c = [ "-march=armv8-a+crc" ]
+        cflags_c = [ "-march=armv8-a+aes+crc" ]
       }
 
       sources = [
diff --git a/third_party/zlib/crc32_simd.c b/third_party/zlib/crc32_simd.c
index 14a8534220538..e94194500f1b1 100644
--- a/third_party/zlib/crc32_simd.c
+++ b/third_party/zlib/crc32_simd.c
@@ -202,6 +202,7 @@ uint32_t ZLIB_INTERNAL crc32_sse42_simd_(  /* SSE4.2+PCLMUL */
  * allowed. We can just include arm_acle.h.
  */
 #include <arm_acle.h>
+#include <arm_neon.h>
 #define TARGET_ARMV8_WITH_CRC
 #else  // !defined(__GNUC__) && !defined(_aarch64__)
 #error ARM CRC32 SIMD extensions only supported for Clang and GCC
-- 
2.34.1

