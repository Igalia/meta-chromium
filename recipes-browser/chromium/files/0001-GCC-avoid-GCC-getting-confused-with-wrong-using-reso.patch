From 9685f9736dacc658a63260de9261ad52356bf080 Mon Sep 17 00:00:00 2001
From: Jose Dapena Paz <jdapena@igalia.com>
Date: Wed, 16 Sep 2020 13:42:00 +0000
Subject: GCC: avoid GCC getting confused with wrong using resolution in
 CrossThreadPersistent
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

In the method to assign a CrossThreadWeakPersistent<U> to a CrossThreadPersistent<T>,
there is a call to the parent class implementation of Get. It uses Parent, that is,
in CrossThreadPersistent<T> an alias to its parent. GCC resolves it as that, but
that's wrong, and it should resolve to the parent of CrossThreadWeakPersistent<U>.

To avoid the problem, we define in that method ParentU resolving to the right
parent, and use a static cast to it.

Bug: 819294
Change-Id: I0152dac92d4a28eb1f1abbc56473204b62f33797
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2412138
Reviewed-by: Kentaro Hara <haraken@chromium.org>
Commit-Queue: Jos√© Dapena Paz <jdapena@igalia.com>
Cr-Commit-Position: refs/heads/master@{#807452}
---
 third_party/blink/renderer/platform/heap/persistent.h | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/third_party/blink/renderer/platform/heap/persistent.h b/third_party/blink/renderer/platform/heap/persistent.h
index f08f42f4070c..32cadc008bf3 100644
--- a/third_party/blink/renderer/platform/heap/persistent.h
+++ b/third_party/blink/renderer/platform/heap/persistent.h
@@ -784,7 +784,9 @@ template <typename U>
 CrossThreadPersistent<T>& CrossThreadPersistent<T>::operator=(
     const CrossThreadWeakPersistent<U>& other) {
   MutexLocker locker(ProcessHeap::CrossThreadPersistentMutex());
-  this->AssignUnsafe(other.Parent::Get());
+  using ParentU = PersistentBase<U, kWeakPersistentConfiguration,
+                                 kCrossThreadPersistentConfiguration>;
+  this->AssignUnsafe(static_cast<const ParentU&>(other).Get());
   return *this;
 }
 
-- 
2.25.1

