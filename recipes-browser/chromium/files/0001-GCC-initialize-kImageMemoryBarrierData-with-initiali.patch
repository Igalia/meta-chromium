From f013df196b8f20ddc25dcf0d8d638b9620bc3d8d Mon Sep 17 00:00:00 2001
From: Jose Dapena Paz <jose.dapena@lge.com>
Date: Tue, 1 Sep 2020 16:38:35 +0200
Subject: GCC: initialize kImageMemoryBarrierData with initializer constructor
 instead of assignment
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

GCC fails to automatically map the initializer assignment for
initializing the angle::PackedEnumMap. So this change adds the
type hint ImageMemoryBarrierData to the second part of the pairs
passed to construct the PackedEnumMap.

./../third_party/angle/src/libANGLE/renderer/vulkan/vk_helpers.cpp:387:1: error: could not convert ‘{{rx::vk::ImageLayout::Undefined, {"Undefined", VK_IMAGE_LAYOUT_UNDEFINED, VK_PIPELINE_STAGE_BOTTOM_OF_PIPE_BIT, VK_PIPELINE_STAGE_TOP_OF_PIPE_BIT, 0, 0, rx::vk::PipelineStage::InvalidEnum}}, {rx::vk::ImageLayout::ExternalPreInitialized, {"ExternalPreInitialized", VK_IMAGE_LAYOUT_PREINITIALIZED, VK_PIPELINE_STAGE_BOTTOM_OF_PIPE_BIT, (((int)VK_PIPELINE_STAGE_HOST_BIT) | ((int)VK_PIPELINE_STAGE_ALL_COMMANDS_BIT)), 0, VK_ACCESS_MEMORY_WRITE_BIT, rx::vk::PipelineStage::InvalidEnum}}, {rx::vk::ImageLayout::ExternalShadersReadOnly, {"ExternalShadersReadOnly", VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL, VK_PIPELINE_STAGE_ALL_COMMANDS_BIT, VK_PIPELINE_STAGE_ALL_COMMANDS_BIT, VK_ACCESS_SHADER_READ_BIT, 0, rx::vk::PipelineStage::TopOfPipe}}, {rx::vk::ImageLayout::ExternalShadersWrite, {"ExternalShadersWrite", VK_IMAGE_LAYOUT_GENERAL, VK_PIPELINE_STAGE_ALL_COMMANDS_BIT, VK_PIPELINE_STAGE_ALL_COMMANDS_BIT, (((int)VK_ACCESS_SHADER_READ_BIT) | ((int)VK_ACCESS_SHADER_WRITE_BIT)), VK_ACCESS_SHADER_WRITE_BIT, rx::vk::PipelineStage::TopOfPipe}}, {rx::vk::ImageLayout::TransferSrc, {"TransferSrc", VK_IMAGE_LAYOUT_TRANSFER_SRC_OPTIMAL, VK_PIPELINE_STAGE_TRANSFER_BIT, VK_PIPELINE_STAGE_TRANSFER_BIT, VK_ACCESS_TRANSFER_READ_BIT, 0, rx::vk::PipelineStage::Transfer}}, {rx::vk::ImageLayout::TransferDst, {"TransferDst", VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL, VK_PIPELINE_STAGE_TRANSFER_BIT, VK_PIPELINE_STAGE_TRANSFER_BIT, VK_ACCESS_TRANSFER_WRITE_BIT, VK_ACCESS_TRANSFER_WRITE_BIT, rx::vk::PipelineStage::Transfer}}, {rx::vk::ImageLayout::VertexShaderReadOnly, {"VertexShaderReadOnly", VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL, VK_PIPELINE_STAGE_VERTEX_SHADER_BIT, VK_PIPELINE_STAGE_VERTEX_SHADER_BIT, VK_ACCESS_SHADER_READ_BIT, 0, rx::vk::PipelineStage::VertexShader}}, {rx::vk::ImageLayout::VertexShaderWrite, {"VertexShaderWrite", VK_IMAGE_LAYOUT_GENERAL, VK_PIPELINE_STAGE_VERTEX_SHADER_BIT, VK_PIPELINE_STAGE_VERTEX_SHADER_BIT, (((int)VK_ACCESS_SHADER_READ_BIT) | ((int)VK_ACCESS_SHADER_WRITE_BIT)), VK_ACCESS_SHADER_WRITE_BIT, rx::vk::PipelineStage::VertexShader}}, {rx::vk::ImageLayout::GeometryShaderReadOnly, {"GeometryShaderReadOnly", VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL, VK_PIPELINE_STAGE_GEOMETRY_SHADER_BIT, VK_PIPELINE_STAGE_GEOMETRY_SHADER_BIT, VK_ACCESS_SHADER_READ_BIT, 0, rx::vk::PipelineStage::GeometryShader}}, {rx::vk::ImageLayout::GeometryShaderWrite, {"GeometryShaderWrite", VK_IMAGE_LAYOUT_GENERAL, VK_PIPELINE_STAGE_GEOMETRY_SHADER_BIT, VK_PIPELINE_STAGE_GEOMETRY_SHADER_BIT, (((int)VK_ACCESS_SHADER_READ_BIT) | ((int)VK_ACCESS_SHADER_WRITE_BIT)), VK_ACCESS_SHADER_WRITE_BIT, rx::vk::PipelineStage::GeometryShader}}, {rx::vk::ImageLayout::FragmentShaderReadOnly, {"FragmentShaderReadOnly", VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL, VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT, VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT, VK_ACCESS_SHADER_READ_BIT, 0, rx::vk::PipelineStage::FragmentShader}}, {rx::vk::ImageLayout::FragmentShaderWrite, {"FragmentShaderWrite", VK_IMAGE_LAYOUT_GENERAL, VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT, VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT, (((int)VK_ACCESS_SHADER_READ_BIT) | ((int)VK_ACCESS_SHADER_WRITE_BIT)), VK_ACCESS_SHADER_WRITE_BIT, rx::vk::PipelineStage::FragmentShader}}, {rx::vk::ImageLayout::ComputeShaderReadOnly, {"ComputeShaderReadOnly", VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL, VK_PIPELINE_STAGE_COMPUTE_SHADER_BIT, VK_PIPELINE_STAGE_COMPUTE_SHADER_BIT, VK_ACCESS_SHADER_READ_BIT, 0, rx::vk::PipelineStage::ComputeShader}}, {rx::vk::ImageLayout::ComputeShaderWrite, {"ComputeShaderWrite", VK_IMAGE_LAYOUT_GENERAL, VK_PIPELINE_STAGE_COMPUTE_SHADER_BIT, VK_PIPELINE_STAGE_COMPUTE_SHADER_BIT, (((int)VK_ACCESS_SHADER_READ_BIT) | ((int)VK_ACCESS_SHADER_WRITE_BIT)), VK_ACCESS_SHADER_WRITE_BIT, rx::vk::PipelineStage::ComputeShader}}, {rx::vk::ImageLayout::AllGraphicsShadersReadOnly, {"AllGraphicsShadersReadOnly", VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL, rx::vk::{anonymous}::kAllShadersPipelineStageFlags, rx::vk::{anonymous}::kAllShadersPipelineStageFlags, VK_ACCESS_SHADER_READ_BIT, 0, rx::vk::PipelineStage::VertexShader}}, {rx::vk::ImageLayout::AllGraphicsShadersWrite, {"AllGraphicsShadersWrite", VK_IMAGE_LAYOUT_GENERAL, rx::vk::{anonymous}::kAllShadersPipelineStageFlags, rx::vk::{anonymous}::kAllShadersPipelineStageFlags, (((int)VK_ACCESS_SHADER_READ_BIT) | ((int)VK_ACCESS_SHADER_WRITE_BIT)), VK_ACCESS_SHADER_WRITE_BIT, rx::vk::PipelineStage::VertexShader}}, {rx::vk::ImageLayout::ColorAttachment, {"ColorAttachment", VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL, VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT, VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT, (((int)VK_ACCESS_COLOR_ATTACHMENT_READ_BIT) | ((int)VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT)), VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT, rx::vk::PipelineStage::ColorAttachmentOutput}}, {rx::vk::ImageLayout::DepthStencilReadOnly, {"DepthStencilReadOnly", VK_IMAGE_LAYOUT_DEPTH_STENCIL_READ_ONLY_OPTIMAL, (((VkPipelineStageFlags)rx::vk::{anonymous}::kAllShadersPipelineStageFlags) | ((VkPipelineStageFlags)((int)VK_PIPELINE_STAGE_EARLY_FRAGMENT_TESTS_BIT))), (((VkPipelineStageFlags)rx::vk::{anonymous}::kAllShadersPipelineStageFlags) | ((VkPipelineStageFlags)((int)VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT))), (((int)VK_ACCESS_SHADER_READ_BIT) | ((int)VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_READ_BIT)), 0, rx::vk::PipelineStage::EarlyFragmentTest}}, {rx::vk::ImageLayout::DepthStencilAttachment, {"DepthStencilAttachment", VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL, VK_PIPELINE_STAGE_EARLY_FRAGMENT_TESTS_BIT, VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT, (((int)VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_READ_BIT) | ((int)VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT)), VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT, rx::vk::PipelineStage::EarlyFragmentTest}}, {rx::vk::ImageLayout::Present, {"Present", VK_IMAGE_LAYOUT_PRESENT_SRC_KHR, VK_PIPELINE_STAGE_BOTTOM_OF_PIPE_BIT, VK_PIPELINE_STAGE_TOP_OF_PIPE_BIT, 0, 0, rx::vk::PipelineStage::BottomOfPipe}}}’ from ‘<brace-enclosed initializer list>’ to ‘const angle::PackedEnumMap<rx::vk::ImageLayout, rx::vk::{anonymous}::ImageMemoryBarrierData>’
  387 | };
      | ^
      | |
      | <brace-enclosed initializer list>

Bug: chromium:819294
---
 src/libANGLE/renderer/vulkan/vk_helpers.cpp | 40 ++++++++++-----------
 1 file changed, 20 insertions(+), 20 deletions(-)

diff --git a/src/libANGLE/renderer/vulkan/vk_helpers.cpp b/src/libANGLE/renderer/vulkan/vk_helpers.cpp
index 8e11774e7..4be7440f1 100644
--- a/src/libANGLE/renderer/vulkan/vk_helpers.cpp
+++ b/src/libANGLE/renderer/vulkan/vk_helpers.cpp
@@ -97,7 +97,7 @@ constexpr VkPipelineStageFlags kAllShadersPipelineStageFlags =
 constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemoryBarrierData = {
     {
         ImageLayout::Undefined,
-        {
+        ImageMemoryBarrierData{
             "Undefined",
             VK_IMAGE_LAYOUT_UNDEFINED,
             VK_PIPELINE_STAGE_BOTTOM_OF_PIPE_BIT,
@@ -111,7 +111,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::ExternalPreInitialized,
-        {
+        ImageMemoryBarrierData{
             "ExternalPreInitialized",
             VK_IMAGE_LAYOUT_PREINITIALIZED,
             VK_PIPELINE_STAGE_BOTTOM_OF_PIPE_BIT,
@@ -125,7 +125,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::ExternalShadersReadOnly,
-        {
+        ImageMemoryBarrierData{
             "ExternalShadersReadOnly",
             VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL,
             VK_PIPELINE_STAGE_ALL_COMMANDS_BIT,
@@ -140,7 +140,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::ExternalShadersWrite,
-        {
+        ImageMemoryBarrierData{
             "ExternalShadersWrite",
             VK_IMAGE_LAYOUT_GENERAL,
             VK_PIPELINE_STAGE_ALL_COMMANDS_BIT,
@@ -155,7 +155,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::TransferSrc,
-        {
+        ImageMemoryBarrierData{
             "TransferSrc",
             VK_IMAGE_LAYOUT_TRANSFER_SRC_OPTIMAL,
             VK_PIPELINE_STAGE_TRANSFER_BIT,
@@ -169,7 +169,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::TransferDst,
-        {
+        ImageMemoryBarrierData{
             "TransferDst",
             VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL,
             VK_PIPELINE_STAGE_TRANSFER_BIT,
@@ -183,7 +183,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::VertexShaderReadOnly,
-        {
+        ImageMemoryBarrierData{
             "VertexShaderReadOnly",
             VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL,
             VK_PIPELINE_STAGE_VERTEX_SHADER_BIT,
@@ -197,7 +197,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::VertexShaderWrite,
-        {
+        ImageMemoryBarrierData{
             "VertexShaderWrite",
             VK_IMAGE_LAYOUT_GENERAL,
             VK_PIPELINE_STAGE_VERTEX_SHADER_BIT,
@@ -211,7 +211,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::GeometryShaderReadOnly,
-        {
+        ImageMemoryBarrierData{
             "GeometryShaderReadOnly",
             VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL,
             VK_PIPELINE_STAGE_GEOMETRY_SHADER_BIT,
@@ -225,7 +225,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::GeometryShaderWrite,
-        {
+        ImageMemoryBarrierData{
             "GeometryShaderWrite",
             VK_IMAGE_LAYOUT_GENERAL,
             VK_PIPELINE_STAGE_GEOMETRY_SHADER_BIT,
@@ -239,7 +239,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::FragmentShaderReadOnly,
-        {
+        ImageMemoryBarrierData{
             "FragmentShaderReadOnly",
             VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL,
             VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT,
@@ -253,7 +253,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::FragmentShaderWrite,
-        {
+        ImageMemoryBarrierData{
             "FragmentShaderWrite",
             VK_IMAGE_LAYOUT_GENERAL,
             VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT,
@@ -267,7 +267,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::ComputeShaderReadOnly,
-        {
+        ImageMemoryBarrierData{
             "ComputeShaderReadOnly",
             VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL,
             VK_PIPELINE_STAGE_COMPUTE_SHADER_BIT,
@@ -281,7 +281,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::ComputeShaderWrite,
-        {
+        ImageMemoryBarrierData{
             "ComputeShaderWrite",
             VK_IMAGE_LAYOUT_GENERAL,
             VK_PIPELINE_STAGE_COMPUTE_SHADER_BIT,
@@ -295,7 +295,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::AllGraphicsShadersReadOnly,
-        {
+        ImageMemoryBarrierData{
             "AllGraphicsShadersReadOnly",
             VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL,
             kAllShadersPipelineStageFlags,
@@ -310,7 +310,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::AllGraphicsShadersWrite,
-        {
+        ImageMemoryBarrierData{
             "AllGraphicsShadersWrite",
             VK_IMAGE_LAYOUT_GENERAL,
             kAllShadersPipelineStageFlags,
@@ -325,7 +325,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::ColorAttachment,
-        {
+        ImageMemoryBarrierData{
             "ColorAttachment",
             VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL,
             VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT,
@@ -339,7 +339,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::DepthStencilReadOnly,
-        {
+        ImageMemoryBarrierData{
             "DepthStencilReadOnly",
             VK_IMAGE_LAYOUT_DEPTH_STENCIL_READ_ONLY_OPTIMAL,
             kAllShadersPipelineStageFlags | VK_PIPELINE_STAGE_EARLY_FRAGMENT_TESTS_BIT,
@@ -353,7 +353,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::DepthStencilAttachment,
-        {
+        ImageMemoryBarrierData{
             "DepthStencilAttachment",
             VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL,
             VK_PIPELINE_STAGE_EARLY_FRAGMENT_TESTS_BIT,
@@ -367,7 +367,7 @@ constexpr angle::PackedEnumMap<ImageLayout, ImageMemoryBarrierData> kImageMemory
     },
     {
         ImageLayout::Present,
-        {
+        ImageMemoryBarrierData{
             "Present",
             VK_IMAGE_LAYOUT_PRESENT_SRC_KHR,
             VK_PIPELINE_STAGE_BOTTOM_OF_PIPE_BIT,
-- 
2.25.1

